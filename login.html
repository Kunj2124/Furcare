<!DOCTYPE html>
<html lang="en">
<head>
  <title>User Login</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="shortcut icon" href="./Media Files/paw.png" type="image/x-icon">
  <link rel="stylesheet" href="https://unicons.iconscout.com/release/v2.1.9/css/unicons.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.0/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/locomotive-scroll@3.5.4/dist/locomotive-scroll.css">
  <link rel="stylesheet" href="login.css">
</head>
<body>
    <div id="loader">
        <div class="dog-loader">
            <div class="dog-body"></div>
            <div class="dog-head">
                <div class="dog-ear dog-ear-left"></div>
                <div class="dog-ear dog-ear-right"></div>
                <div class="dog-eye dog-eye-left"></div>
                <div class="dog-eye dog-eye-right"></div>
                <div class="dog-nose"></div>
            </div>
            <div class="dog-tail"></div>
            <div class="dog-leg leg-1"></div>
            <div class="dog-leg leg-2"></div>
            <div class="dog-leg leg-3"></div>
            <div class="dog-leg leg-4"></div>
            <div class="paw-prints">
                <div class="paw"></div>
                <div class="paw"></div>
                <div class="paw"></div>
                <div class="paw"></div>
                <div class="paw"></div>
            </div>
            <div class="loading-text">FurCare Loading...</div>
        </div>
    </div>
    <div class="section">
        <div class="container">
            <div class="row full-height justify-content-center">
                <div class="col-12 text-center align-self-center py-5">
                    <div class="section pb-5 pt-5 pt-sm-2 text-center">
                        <h6 class="mb-0 pb-3"><span>Log In </span><span>Sign Up</span></h6>
                        <input class="checkbox" type="checkbox" id="reg-log" name="reg-log"/>
                        <label for="reg-log"></label>
                        <div class="card-3d-wrap mx-auto">
                            <div class="card-3d-wrapper">
                                <div class="card-front">
                                    <div class="center-wrap">
                                        <div class="section text-center">
                                            <h4 class="mb-4 pb-3">Log In</h4>
                                            <div class="form-group">
                                                <input type="email" class="form-style" id="loginEmail" placeholder="Email">
                                                <i class="input-icon uil uil-at"></i>
                                            </div>    
                                            <div class="form-group mt-2">
                                                <input type="password" class="form-style" id="loginPassword" placeholder="Password">
                                                <i class="input-icon uil uil-lock-alt"></i>
                                            </div>
                                            <div id="loginError" class="text-danger mt-2"></div>
                                            <button class="btn mt-4" id="loginBtn">Login</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-back">
                                    <div class="center-wrap">
                                        <div class="section text-center">
                                            <h4 class="mb-3 pb-3">Sign Up</h4>
                                            <div class="form-group">
                                                <input type="text" class="form-style" placeholder="Full Name" id="fullName">
                                                <i class="input-icon uil uil-user"></i>
                                            </div>    
                                            <div class="form-group mt-2">
                                                <input type="tel" class="form-style" placeholder="Phone Number" id="phoneNumber">
                                                <i class="input-icon uil uil-phone"></i>
                                            </div>    
                                            <div class="form-group mt-2">
                                                <input type="email" class="form-style" placeholder="Email" id="email">
                                                <i class="input-icon uil uil-at"></i>
                                            </div>
                                            <div class="form-group mt-2">
                                                <input type="password" class="form-style" placeholder="Password" id="password">
                                                <i class="input-icon uil uil-lock-alt"></i>
                                            </div>
                                            <div id="registerError" class="text-danger mt-2"></div>
                                            <button class="btn mt-4" id="registerBtn">Register</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Loading animation
        document.addEventListener("DOMContentLoaded", function() {
            setTimeout(function() {
                document.body.classList.add("loaded");
            }, 1000);
        });

        // API endpoints
        const API_BASE_URL = 'http://localhost:8081/api';

        // Registration functionality
        document.getElementById("registerBtn").addEventListener('click', async function(e) {
            e.preventDefault();
            const fullName = document.getElementById("fullName").value;
            const phoneNumber = document.getElementById("phoneNumber").value;
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;
            const errorElement = document.getElementById("registerError");

            try {
                // Validate inputs
                if (!fullName || !phoneNumber || !email || !password) {
                    throw new Error("All fields are required");
                }

                if (password.length < 6) {
                    throw new Error("Password must be at least 6 characters long");
                }

                const response = await fetch(`${API_BASE_URL}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        fullName,
                        phoneNumber,
                        email,
                        password,
                        role: "USER"
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Registration failed');
                }

                // Store the JWT token
                localStorage.setItem('token', data.token);
                localStorage.setItem('user', JSON.stringify(data.user));
                
                alert("Registration successful! Please login.");
                document.getElementById("reg-log").checked = false;
                errorElement.textContent = "";
            } catch (error) {
                console.error('Registration error:', error);
                if (error.message === 'Failed to fetch') {
                    errorElement.textContent = "Cannot connect to server. Please check if the server is running and try again.";
                } else {
                    errorElement.textContent = error.message;
                }
            }
        });

        // Login functionality
        document.getElementById("loginBtn").addEventListener('click', async function(e) {
            e.preventDefault();
            const email = document.getElementById("loginEmail").value;
            const password = document.getElementById("loginPassword").value;
            const errorElement = document.getElementById("loginError");
            const loginBtn = document.getElementById("loginBtn");

            try {
                // Validate inputs
                if (!email || !password) {
                    throw new Error("Email and password are required");
                }

                // Disable button and show loading state
                loginBtn.disabled = true;
                loginBtn.textContent = "Logging in...";

                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        email,
                        password
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'Login failed');
                }
                
                // Store the JWT token and user data
                localStorage.setItem('token', data.token);
                localStorage.setItem('user', JSON.stringify(data.user));
                
                // Redirect to home page
                window.location.href = './home.html';
            } catch (error) {
                console.error('Login error:', error);
                if (error.message === 'Failed to fetch') {
                    errorElement.textContent = "Cannot connect to server. Please check if the server is running and try again.";
                } else {
                    errorElement.textContent = error.message || "Invalid email or password";
                }
            } finally {
                // Re-enable button and restore text
                loginBtn.disabled = false;
                loginBtn.textContent = "Login";
            }
        });

        async function registerUser(event) {
            event.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const fullName = document.getElementById('fullName').value;
            const phoneNumber = document.getElementById('phoneNumber').value;

            try {
                const response = await fetch('http://localhost:8081/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email,
                        password,
                        fullName,
                        phoneNumber
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Registration failed');
                }

                // Store the token
                localStorage.setItem('token', data.token);
                localStorage.setItem('user', JSON.stringify(data.user));

                // Show success message
                showMessage('Registration successful! Redirecting to dashboard...', 'success');
                
                // Redirect to dashboard after a short delay
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 2000);

            } catch (error) {
                console.error('Registration error:', error);
                showMessage(error.message || 'Registration failed. Please try again.', 'error');
            }
        }

        async function loginUser(event) {
            event.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch('http://localhost:8081/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email,
                        password
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'Login failed');
                }

                // Store the token
                localStorage.setItem('token', data.token);
                localStorage.setItem('user', JSON.stringify(data.user));

                // Show success message
                showMessage('Login successful! Redirecting to dashboard...', 'success');
                
                // Redirect to dashboard after a short delay
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 2000);

            } catch (error) {
                console.error('Login error:', error);
                showMessage(error.message || 'Login failed. Please check your credentials.', 'error');
            }
        }

        function showMessage(message, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = message;
            messageDiv.className = `message ${type}`;
            messageDiv.style.display = 'block';
        }
    </script>
</body>
</html>
